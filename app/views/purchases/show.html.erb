<%# 購入履歴詳細 %>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <span>
        <%= link_to "マイページ", mypage_users_path %> > <%= link_to "購入履歴", mypage_purchases_users_path %> > 購入履歴詳細
      </span>

      <div class="content mt-3">
        <h1 class="purchase-title">購入履歴詳細</h1>

        <h4 class="mt-3">ご注文情報</h4>

        <hr>

        <div class="row">
          <div class="col-5 mt-2">
            注文番号
          </div>
          <div class="col-7 mt-2">
            <%= @cart.id %>
          </div>

          <div class="col-5 mt-2">
            注文日時
          </div>
          <div class="col-7 mt-2">
            <%= @cart.updated_at.strftime("%Y-%m-%d %H:%M:%S") %>
          </div>
          <%# shipping_costメソッドではカート内の商品の送料有無carriage_flagの値を取得し、1つでもtrueの商品が含まれていれば合計金額に送料を加算する %>
          <div class="col-5 mt-2">
            商品の小計
          </div>
          <div class="col-7 mt-2">
            ￥<%= ((@cart.total - @cart.shipping_cost).fractional / 100 ).to_s(:delimited)%>
          </div>    
          
          <div class="col-5 mt-2">
            送料
          </div>
          <div class="col-7 mt-2">
            ￥<%= (@cart.shipping_cost.fractional / 100).to_s(:delimited) %>
          </div>        

          <div class="col-5 mt-2">
            合計金額
          </div>
          <div class="col-7 mt-2">
            ￥<%= (@cart.total.fractional / 100).to_s(:delimited) %>
          </div>

          <div class="col-5 mt-2">
            点数
          </div>
          <div class="col-7 mt-2">
            <%= ShoppingCartItem.user_cart_items(@cart.id).count %>点
          </div>

        </div>

        <hr>

        <div class="row">
          <% @cart_items.each do |cart_item| %>
          <%# productモデルからカートの中に入ったアイテムを見つける %>
            <% product = Product.find(cart_item.item_id) %>
            <div class="col-md-5 mt-2">
              <%= link_to product_path(product), class: "ml-4" do %>
                <% if product.image.attached? %>
                  <%= image_tag product.image, width:"200", height: "200" %>
                <% else %>
                  <%= image_tag "jam.png", width:"200", height: "200" %>
                <% end %>            
              <% end %>
            </div>
            <div class="col-md-7 mt-2">
              <div class="flex-cloumn">
                <p class="mt-4"><%= product.name %></p>
                <div class="row">
                  <div class="col-2 mt-2">
                    数量
                  </div>
                  <div class="col-10 mt-2">
                    <%= cart_item.quantity %>
                  </div>
    
                  <div class="col-2 mt-2">
                    小計
                  </div>
                  <div class="col-10 mt-2">
                    ￥<%= price = (cart_item.price_cents * cart_item.quantity).to_s(:delimited) %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
